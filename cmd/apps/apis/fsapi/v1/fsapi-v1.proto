syntax = "proto3";

package api.v1;

option go_package = "github.com/basenana/nanafs/cmd/apps/apis/fsapi/v1";

import "google/protobuf/timestamp.proto";

service Auth {
  rpc AccessToken (AccessTokenRequest) returns (AccessTokenResponse) {}
}

message AccessTokenRequest {
  string AccessTokenKey = 1;
  string SecretToken = 2;
}

message AccessTokenResponse {
  string Namespace = 1;
  int64 UID = 2;
  int64 GID = 3;
  string ClientCrt = 4;
  string ClientKey = 5;
  google.protobuf.Timestamp CertExpiration = 6;
}

service Inbox {
  rpc QuickInbox (QuickInboxRequest) returns (QuickInboxResponse) {}
}

message QuickInboxRequest {
  enum SourceType {UrlSource = 0;}
  enum FileType {
    BookmarkFile = 0;
    HtmlFile = 1;
    WebArchiveFile = 2;
  }

  SourceType sourceType = 1;
  FileType fileType = 2;
  string filename = 3;
  string url = 4;
  bytes data = 5;

  // url source
  bool clutterFree = 10;
}

message QuickInboxResponse {
  int64 entryID = 1;
  string jobID = 2;
}

service Entries {
  rpc GroupTree (GetGroupTreeRequest) returns (GetGroupTreeResponse) {}
  rpc FindEntryDetail (FindEntryDetailRequest) returns (GetEntryDetailResponse) {}
  rpc GetEntryDetail (GetEntryDetailRequest) returns (GetEntryDetailResponse) {}
  rpc CreateEntry (CreateEntryRequest) returns (CreateEntryResponse) {}
  rpc UpdateEntry (UpdateEntryRequest) returns (UpdateEntryResponse) {}
  rpc DeleteEntry (DeleteEntryRequest) returns (DeleteEntryResponse) {}
  rpc ListGroupChildren (ListGroupChildrenRequest) returns (ListGroupChildrenResponse) {}
  rpc ChangeParent (ChangeParentRequest) returns (ChangeParentResponse) {}

  rpc WriteFile (stream WriteFileRequest) returns (WriteFileResponse) {}
  rpc ReadFile (ReadFileRequest) returns (stream ReadFileResponse) {}
}

message Pagination {
  int64 page = 1;
  int64 pageSize = 2;
}

message GetGroupTreeRequest {}

message GetGroupTreeResponse {
  message GroupEntry {
    EntryInfo entry = 1;
    repeated GroupEntry children = 2;
  }
  GroupEntry root = 1;
}

message FindEntryDetailRequest {
  bool root = 1;
  int64 parentID = 2;
  string name = 3;
}

message GetEntryDetailRequest {
  int64 entryID = 1;
}

message GetEntryDetailResponse {
  EntryDetail entry = 1;
  repeated Property properties = 2;
}

message CreateEntryRequest {
  int64 parentID = 1;
  string  name = 2;
  string kind = 3;
}

message CreateEntryResponse {
  EntryInfo entry = 1;
}

message UpdateEntryRequest {
  EntryDetail entry = 1;
}
message UpdateEntryResponse {
  EntryDetail entry = 1;
}

message DeleteEntryRequest {
  int64 entryID = 1;
}
message DeleteEntryResponse {
  EntryDetail entry = 1;
}

message EntryFilter {
  string fuzzyName = 1;
  string kind = 2;
  enum GroupFilter {
    All = 0;
    Group = 1;
    File = 2;
  }
  GroupFilter isGroup = 3;
  google.protobuf.Timestamp createdAtStart = 6;
  google.protobuf.Timestamp createdAtEnd = 7;
  google.protobuf.Timestamp modifiedAtStart = 8;
  google.protobuf.Timestamp modifiedAtEnd = 9;
}

message ListGroupChildrenRequest {
  int64 parentID = 1;

  Pagination pagination = 10;
  enum EntryOrder {
    Name = 0;
    Kind = 1;
    IsGroup = 2;
    Size = 3;
    CreatedAt = 4;
    ModifiedAt = 5;
  }
  EntryOrder order = 11;
  bool OrderDesc = 12;
  EntryFilter filter = 13;
}

message ListGroupChildrenResponse {
  repeated EntryInfo entries = 1;
}

message ChangeParentRequest {
  message Option {
    bool Replace = 1;
    bool Exchange = 2;
  }
  int64 entryID = 1;
  int64 newParentID = 2;
  string newName = 3;
  Option option = 4;
}

message ChangeParentResponse {
  EntryInfo entry = 1;
}

message WriteFileRequest {
  int64 entryID = 1;
  int64 off = 2;
  int64 len = 3;
  bytes data = 4;
}

message WriteFileResponse {
  int64 len = 1;
}

message ReadFileRequest {
  int64 entryID = 1;
  int64 off = 2;
  int64 len = 3;
}

message ReadFileResponse {
  int64 off = 1;
  int64 len = 2;
  bytes data = 3;
}

service Properties {
  rpc AddProperty (AddPropertyRequest) returns (AddPropertyResponse) {}
  rpc UpdateProperty (UpdatePropertyRequest) returns (UpdatePropertyResponse) {}
  rpc DeleteProperty (DeletePropertyRequest) returns (DeletePropertyResponse) {}
}

message Property {
  string key = 1;
  string value = 2;
  bool encoded = 3;
}

message AddPropertyRequest {
  int64 entryID = 1;
  string key = 2;
  string value = 3;
}

message AddPropertyResponse {
  EntryInfo entry = 1;
  repeated Property properties = 2;
}

message UpdatePropertyRequest {
  int64 entryID = 1;
  string key = 2;
  string value = 3;
}

message UpdatePropertyResponse {
  EntryInfo entry = 1;
  repeated Property properties = 2;
}

message DeletePropertyRequest {
  int64 entryID = 1;
  string key = 2;
}

message DeletePropertyResponse {
  EntryInfo entry = 1;
  repeated Property properties = 2;
}

service Document {
  rpc ListDocuments (ListDocumentsRequest) returns (ListDocumentsResponse) {}
  rpc GetDocumentDetail (GetDocumentDetailRequest) returns (GetDocumentDetailResponse) {}
  rpc UpdateDocument (UpdateDocumentRequest) returns (UpdateDocumentResponse) {}
  rpc SearchDocuments (SearchDocumentsRequest) returns (SearchDocumentsResponse) {}
}

message DocumentFilter {
  string fuzzyName = 1;
  int64 parentEntryID = 2;
  string source = 3;
  bool marked = 4;
  bool unread = 5;
  google.protobuf.Timestamp createdAtStart = 6;
  google.protobuf.Timestamp createdAtEnd = 7;
  google.protobuf.Timestamp changedAtStart = 8;
  google.protobuf.Timestamp changedAtEnd = 9;
}

message ListDocumentsRequest {
  bool listAll = 1;
  int64 parentID = 2;
  Pagination pagination = 10;
  enum DocumentOrder {
    Name = 0;
    Source = 1;
    Marked = 2;
    Unread = 3;
    CreatedAt = 4;
  }
  DocumentOrder order = 11;
  bool OrderDesc = 12;
  DocumentFilter filter = 13;
}

message ListDocumentsResponse {
  repeated DocumentInfo documents = 1;
}

message GetDocumentDetailRequest {
  int64 documentID = 1;
  int64 entryID = 2;
}

message GetDocumentDetailResponse {
  DocumentDescribe document = 1;
}

message UpdateDocumentRequest {
  enum DocumentMark {
    Unchanged = 0;
    Marked = 1;
    Unmarked = 2;
    Read = 3;
    Unread = 4;
  }
  DocumentDescribe document = 1;
  DocumentMark setMark = 2;
}

message UpdateDocumentResponse {
  DocumentDescribe document = 1;
}

message SearchDocumentsRequest {
  string query = 1;
}

message SearchDocumentsResponse {
  repeated DocumentInfo documents = 1;
}

service Room {
  rpc ListRooms (ListRoomsRequest) returns (ListRoomsResponse) {}
  rpc OpenRoom (OpenRoomRequest) returns (OpenRoomResponse) {}
  rpc UpdateRoom (UpdateRoomRequest) returns (UpdateRoomResponse) {}
  rpc DeleteRoom (DeleteRoomRequest) returns (DeleteRoomResponse) {}
  rpc ClearRoom (ClearRoomRequest) returns (ClearRoomResponse) {}
  rpc ChatInRoom (ChatRequest) returns (stream ChatResponse) {}
}

message RoomInfo {
  int64 id = 1;
  int64 entryID = 2;
  string title = 3;
  string prompt = 4;
  string namespace = 5;
  repeated RoomMessage messages = 10;
  google.protobuf.Timestamp createdAt = 11;
}

message RoomMessage {
  int64 id = 1;
  int64 roomID = 2;
  string sender = 3;
  string message = 4;
  string namespace = 5;
  google.protobuf.Timestamp sendAt = 6;
  google.protobuf.Timestamp createdAt = 10;
}

message ListRoomsRequest {
  int64 entryID = 1;
}

message ListRoomsResponse {
  repeated RoomInfo rooms = 1;
}

message OpenRoomRequest {
  message Option {
    string prompt = 1;
  }
  int64 entryID = 1;
  int64 roomID = 2;
  Option option = 3;
}

message OpenRoomResponse {
  RoomInfo room = 1;
}

message UpdateRoomRequest {
  int64 roomID = 1;
  string prompt = 2;
}

message UpdateRoomResponse {
  int64 roomID = 1;
}

message DeleteRoomRequest {
  int64 roomID = 1;
}

message ClearRoomRequest {
  int64 roomID = 1;
}

message DeleteRoomResponse {
  int64 roomID = 1;
}

message ClearRoomResponse {
  int64 roomID = 1;
}

message ChatRequest {
  int64 roomID = 1;
  string newRequest = 3;
  google.protobuf.Timestamp sendAt = 10;
}

message ChatResponse {
  int64 requestID = 1;
  int64 responseID = 2;
  string responseMessage = 3;
  string sender = 4;
  google.protobuf.Timestamp sendAt = 10;
  google.protobuf.Timestamp createdAt = 11;
}

service Notify {
  rpc GetLatestSequence (GetLatestSequenceRequest) returns (GetLatestSequenceResponse) {}
  rpc ListUnSyncedEvent (ListUnSyncedEventRequest) returns (ListUnSyncedEventResponse) {}
  rpc CommitSyncedEvent (CommitSyncedEventRequest) returns (CommitSyncedEventResponse) {}
}

message GetLatestSequenceRequest {
  int64 startSequence = 1;
}

message GetLatestSequenceResponse {
  int64 sequence = 1;
  bool needRelist = 2;
}

message ListUnSyncedEventRequest {
  int64 startSequence = 1;
}

message ListUnSyncedEventResponse {
  repeated Event events = 1;
}

message CommitSyncedEventRequest {
  string deviceID = 1;
  int64 sequence = 2;
}

message CommitSyncedEventResponse {}

service Workflow {
  rpc TriggerWorkflow (TriggerWorkflowRequest) returns (TriggerWorkflowResponse) {}
}

message TriggerWorkflowRequest {
  message WorkflowTarget {
    int64 entryID = 1;
    int64 parentEntryID = 2;
  }
  message WorkflowJobAttr {
    string reason = 1;
    int64 timeout = 2;
  }
  string workflowID = 1;
  WorkflowTarget target = 2;
  WorkflowJobAttr attr = 3;
}

message TriggerWorkflowResponse {
  string jobID = 1;
}

message DocumentInfo {
  int64 id = 1;
  string name = 2;
  int64 entryID = 3;
  int64 parentEntryID = 4;
  string source = 5;
  bool marked = 6;
  bool unread = 7;
  string namespace = 8;
  string subContent = 9;
  google.protobuf.Timestamp createdAt = 30;
  google.protobuf.Timestamp changedAt = 31;
}

message DocumentDescribe {
  int64 id = 1;
  string name = 2;
  int64 entryID = 3;
  int64 parentEntryID = 4;
  string source = 5;
  bool marked = 6;
  bool unread = 7;
  string namespace = 8;

  string htmlContent = 10;
  repeated string keyWords = 11;
  string summary = 12;

  EntryInfo entryInfo = 20;

  google.protobuf.Timestamp createdAt = 30;
  google.protobuf.Timestamp changedAt = 31;
}

message EntryInfo {
  int64 id = 1;
  string name = 2;
  string kind = 3;
  bool isGroup = 6;
  int64 size = 7;
  google.protobuf.Timestamp createdAt = 30;
  google.protobuf.Timestamp changedAt = 31;
  google.protobuf.Timestamp modifiedAt = 32;
  google.protobuf.Timestamp accessAt = 33;
}

message EntryDetail {

  message Access  {
    int64 uid = 1;
    int64 gid = 2;
    repeated string permissions = 3;
  }

  int64 id = 1;
  string name = 2;
  string aliases = 3;
  EntryInfo parent = 4;
  string kind = 5;
  bool isGroup = 6;
  int64 size = 10;
  int64 version = 11;
  string namespace = 12;
  string storage = 13;
  Access access = 14;
  google.protobuf.Timestamp createdAt = 30;
  google.protobuf.Timestamp changedAt = 31;
  google.protobuf.Timestamp modifiedAt = 32;
  google.protobuf.Timestamp accessAt = 33;
}

message Event {

  message EventData {
    int64 id = 1;
    int64 parentID = 2;
    string kind = 3;
    bool isGroup = 4;
    string namespace = 5;
  }

  string id = 1;
  string type = 2;
  string source = 3;
  string specVersion = 4;
  string dataContentType = 5;
  EventData data = 6;
  google.protobuf.Timestamp time = 7;

  int64 refID = 10;
  string refType = 11;
  int64 sequence = 12;
}
